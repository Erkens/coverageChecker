#!/usr/bin/env php
<?php

foreach (array(__DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php') as $file) {
    if (file_exists($file)) {
        require_once($file);

        break;
    }
}

if (!isset($argv[1], $argv[2])) {
    echo "Missing arguments, please call with diff and check file" . PHP_EOL;
    exit(1);
}

if ($argv[1] == "-") {
        $argv[1] = "php://stdin";
}
if ($argv[2] == "-") {
        $argv[2] = "php://stdin";
}

$minimumPercentCovered = 100;
if (isset($argv[3])) {
    $minimumPercentCovered = min($minimumPercentCovered, max(0, $argv[3]));
}


$matcher = new exussum12\CoverageChecker\FileMatchers\EndsWith();
$diff = new  exussum12\CoverageChecker\DiffFileLoader($argv[1]);
$phpunit = new exussum12\CoverageChecker\XMLReport($argv[2]);
$coverageCheck = new exussum12\CoverageChecker\CoverageCheck($diff, $phpunit, $matcher);

$lines = $coverageCheck->getCoveredLines();

$coveredLines = count($lines['coveredLines'], COUNT_RECURSIVE);
$uncoveredLines = count($lines['uncoveredLines'], COUNT_RECURSIVE);

if($coveredLines + $uncoveredLines == 0) {
    exit(0);
}

$percentCovered = 100 * ($coveredLines / ($coveredLines + $uncoveredLines));
if ($percentCovered >= $minimumPercentCovered) {
    exit(0);
}

echo "$percentCovered% Covered, Missed lines " . PHP_EOL;
print_r($lines['uncoveredLines']);
exit(2);
